<!DOCTYPE html><html lang="ko" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="자바 ORM 표준 JPA 프로그래밍(희망편09)" /><meta property="og:locale" content="ko" /><meta name="description" content="Chapter 10. 객체지향 쿼리 언어" /><meta property="og:description" content="Chapter 10. 객체지향 쿼리 언어" /><link rel="canonical" href="https://redbean88.github.io/posts/JPA-CH09/" /><meta property="og:url" content="https://redbean88.github.io/posts/JPA-CH09/" /><meta property="og:site_name" content="dev note" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-05-16T21:20:01+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="자바 ORM 표준 JPA 프로그래밍(희망편09)" /><meta name="twitter:site" content="@redbean88" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-05-17T00:01:21+09:00","datePublished":"2022-05-16T21:20:01+09:00","description":"Chapter 10. 객체지향 쿼리 언어","headline":"자바 ORM 표준 JPA 프로그래밍(희망편09)","mainEntityOfPage":{"@type":"WebPage","@id":"https://redbean88.github.io/posts/JPA-CH09/"},"url":"https://redbean88.github.io/posts/JPA-CH09/"}</script><title>자바 ORM 표준 JPA 프로그래밍(희망편09) | dev note</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="dev note"><meta name="application-name" content="dev note"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/favicons/android-chrome-384x384.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">dev note</a></div><div class="site-subtitle font-italic">학습한것을 기록합니다.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/redbean88" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/redbean88" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['doctortor88','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>자바 ORM 표준 JPA 프로그래밍(희망편09)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>자바 ORM 표준 JPA 프로그래밍(희망편09)</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> redbean88 </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, May 16, 2022, 9:20 PM +0900" >May 16, 2022<i class="unloaded">2022-05-16T21:20:01+09:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Tue, May 17, 2022, 12:01 AM +0900" >May 17, 2022<i class="unloaded">2022-05-17T00:01:21+09:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="7866 words">43 min read</span></div></div><div class="post-content"><h1 id="chapter-10-객체지향-쿼리-언어">Chapter 10. 객체지향 쿼리 언어</h1><blockquote><p><strong><em>이장의 내용</em></strong></p><ul><li><em>객체지향 쿼리 소개</em><li><em>JPQL</em><li><del><em>Criteria</em></del><li><em>QueryDSL</em><li>네이티브 SQL<li>객체지향 쿼리 심화</ul></blockquote><h2 id="91-객체지향-쿼리-소개">9.1 객체지향 쿼리 소개</h2><ul><li>테이블이 아닌 객체를 대상으로 검색하는 객체지향 쿼리다.<li>SQL을 추상화해서 특정 데이터베이스 SQL에 의존하지 않는다.</ul><h2 id="92-jpql">9.2 JPQL</h2><ul><li>JPQL<sup>Java Persistence Query Language</sup>은 엔티티 객체를 조회하는 객체지향 쿼리다.<li>JPQL은 결국 SQL로 변환된다.</ul><blockquote><p>Criteria나 QueryDSL도 결국 JPQL을 만들어주는 빌더 역할을 할 뿐이므로 JPQL을 잘 알아야 한다.</p></blockquote><h3 id="921-기본-문법과-쿼리-api">9.2.1 기본 문법과 쿼리 API</h3><p>JPQL도 SQL과 비슷하게 SELECT, UPDATE, DELETE 문을 사용할 수 있다. 엔티티를 저장할 때는 em.persist() 메서드를 사용하면 되므로 INSERT 문은 없다.</p><h4 id="select-문">SELECT 문</h4><p><code class="language-plaintext highlighter-rouge">SELECT m FROM Member AS m WHERE m.username = 'Hello' </code></p><ul><li><p><strong>대소문자 구분</strong></p><p>JPQL 키워드를 제외한 엔티티와 속성은 대소문자를 구분한다.</p><li><p><strong>엔티티 이름</strong></p><p>Member는 클래스 명이 아니라 엔티티 명이다. 기본값인 클래스 명을 엔티티 명으로 사용하는 것을 추천한다.</p><li><p><strong>별칭은 필수</strong></p><p>Member AS m처럼 JPQL은 별칭을 필수로 사용해야 한다. AS는 생략할 수 있다.</p></ul><h4 id="typedquery-query">TypedQuery, Query</h4><p>작성한 JPQL을 실행하려면 쿼리 객체를 만들어야 한다.</p><p>반환할 타입을 명확하게 지정할 수 있으면 TypedQuery 객체를 사용하고, 반환 타입을 명확하게 지정할 수 없으면 Query 객체를 사용하면 된다.</p><blockquote><p><em>TypeQuery 사용</em></p></blockquote><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nc">TypedQuery</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span>
  <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"SELECT m FROM Member m"</span><span class="o">,</span> <span class="nc">Member</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="n">resultList</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">em.createQuery()</code>의 두 번째 파라미터에 반환할 타입을 지정하면 TypeQuery를 반환하고 지정하지 않으면 Query를 반환한다. 여기선 조회 대상이 Member 엔티티이므로 대상 타입이 명확하다.</p><blockquote><p><em>Query 사용</em></p></blockquote><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nc">Query</span> <span class="n">query</span> <span class="o">=</span> 
  <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"SELECT m.username, m.age from Member m"</span><span class="o">);</span>

<span class="nc">List</span> <span class="n">resultList</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
</pre></table></code></div></div><p>여기선 조회 대상이 String 타입과 Integer 타입이므로 조회 대상 타입이 명확하지 않다. Query 객체는 SELECT 절의 조회 대상이 둘 이상이면 Object[]를 반환하고 하나면 Object를 반환한다.</p><p>일반적으로 타입을 변환할 필요가 없는 TypedQuery를 사용하는 것이 더 편리하다.</p><h4 id="결과-조회">결과 조회</h4><p>다음 메서드들을 호출하면 실제 쿼리를 실행해서 데이터베이스를 조회한다.</p><ul><li>query.getResultList(): 결과를 리스트로 반환한다. 결과가 없으면 빈 컬렉션을 반환한다.<li>query.getSingleResult(): 결과가 정확히 하나일 때 사용한다.<ul><li>결과가 없으면 NoResultException 발생<li>1개보다 많으면 NonUniqueResultException 발생</ul></ul><h3 id="922-파라미터-바인딩">9.2.2 파라미터 바인딩</h3><p>JDBC는 위치 기준 파라미터 바인딩만 지원하지만 JPQL은 이름 기준 파라미터 바인딩도 지원한다.</p><ul><li><p><strong>이름 기준 파라미터</strong></p><p>파라미터를 이름으로 구분하는 방법. 앞에 <code class="language-plaintext highlighter-rouge">:</code>를 사용한다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nc">String</span> <span class="n">usernameParam</span> <span class="o">=</span> <span class="s">"User1"</span><span class="o">;</span>
  
<span class="nc">TypedQuery</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span> 
  <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"select m from Member m where m.username = :username"</span><span class="o">,</span>
                <span class="nc">Member</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  
<span class="n">query</span><span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"username"</span><span class="o">,</span> <span class="n">usernameParam</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="n">resultList</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
</pre></table></code></div></div><p>추가로 JPQL API는 대부분 메서드 체인 방식으로 설계되어 다음과 같이 작성할 수도 있다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="n">members</span> <span class="o">=</span> 
  <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"select m from Member m where m.username = :username"</span><span class="o">,</span>
                <span class="nc">Member</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"username"</span><span class="o">,</span> <span class="n">usernameParam</span><span class="o">)</span>
  <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
</pre></table></code></div></div><li><p><strong>위치 기준 파라미터</strong></p><p><code class="language-plaintext highlighter-rouge">?</code> 다음에 위치 값을 주면 된다. 위치 값은 1부터 시작한다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="n">members</span> <span class="o">=</span>
  <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"select m from Member m where m.username = ?1"</span><span class="o">,</span> <span class="nc">Member</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">usernameParam</span><span class="o">)</span>
  <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
</pre></table></code></div></div></ul><p>이름 기준 파라미터 바인딩 방식을 사용하는 것이 더 명확한 방법이다.</p><h3 id="923-프로젝션">9.2.3 프로젝션</h3><p>SELECT 절에 조회할 대상을 지정하는 것을 프로젝션이라 한다.</p><ul><li><p><strong>엔티티 프로젝션</strong></p><p><code class="language-plaintext highlighter-rouge">SELECT m FROM Member m</code></p><p><code class="language-plaintext highlighter-rouge">SELECT m.team FROM Member m</code></p><p>조회한 엔티티는 영속성 컨텍스트에서 관리된다.</p><li><p><strong>임베디드 타입 프로젝션</strong></p><p>임베디드 타입은 엔티티와 거의 비슷하게 사용되지만 조회의 시작점이 될 수 없다는 제약이 있다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nc">String</span> <span class="n">query</span> <span class="o">=</span> <span class="s">"SELECT o.address FROM Order o"</span><span class="o">;</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Address</span><span class="o">&gt;</span> <span class="n">addresses</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="nc">Address</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  													<span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
</pre></table></code></div></div><p>임베디드 타입은 엔티티 타입이 아닌 값 타입이다. 따라서 영속성 컨텍스트에서 관리되지 않는다.</p><li><p><strong>스칼라 타입 프로젝션</strong></p><p>숫자, 문자, 날짜와 같은 기본 데이터 타입을 스칼라 타입이라 한다. 통계 쿼리도 주로 스칼라 타입으로 조회한다.</p><li><p><strong>NEW 명령어</strong></p><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nc">TypedQuery</span><span class="o">&lt;</span><span class="nc">UserDTO</span><span class="o">&gt;</span> <span class="n">query</span> <span class="o">=</span>
  <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"SELECT new jpabook.jpql.UserDTO(m.username, m.age) FROM Member m"</span><span class="o">,</span>
                 <span class="nc">UserDTO</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">UserDTO</span><span class="o">&gt;</span> <span class="n">resultList</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
</pre></table></code></div></div><p>NEW 명령어를 사용한 클래스로 지루한 객체 변환 작업을 줄일 수 있다. 사용 시 다음 2가지를 주의해야 한다.</p><ol><li>패키지 명을 포함한 전체 클래스 명을 입력해야 한다.<li>순서와 타입이 일치하는 생성자가 필요하다.</ol></ul><h3 id="924-페이징-api">9.2.4 페이징 API</h3><p>페이징 처리용 SQL은 지루하고 반복적인데다가 데이터베이스마다 처리하는 SQL이 다르다.</p><p>JPA는 페이징을 두 API로 추상화했다.</p><ul><li>setFirstResult(int startPosition): 조회 시작 위치 (0부터 시작)<li>setMaxResults(int maxResult): 조회할 데이터 수</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="n">members</span> <span class="o">=</span> 
  <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"SELECT m FROM Member m ORDER BY m.username DESC"</span><span class="o">,</span>
                <span class="nc">Member</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="o">.</span><span class="na">setFirstResult</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>
  <span class="o">.</span><span class="na">setMaxResults</span><span class="o">(</span><span class="mi">20</span><span class="o">)</span>
  <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
</pre></table></code></div></div><h3 id="925-집합과-정렬">9.2.5 집합과 정렬</h3><div class="language-sql highlighter-rouge"><div class="code-header"> <span text-data=" Sql "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">select</span>
  <span class="k">count</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>
  <span class="k">sum</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">age</span><span class="p">),</span>
  <span class="k">avg</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">age</span><span class="p">),</span>
  <span class="k">max</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">age</span><span class="p">),</span>
  <span class="k">min</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">age</span><span class="p">)</span>
<span class="k">from</span> <span class="n">Member</span> <span class="n">m</span>
</pre></table></code></div></div><h4 id="참고-사항">참고 사항</h4><ul><li><p>DISTINCT를 집합 함수 안에 사용해서 중복된 값을 제거하고 나서 집합을 구할 수 있다.</p><p><code class="language-plaintext highlighter-rouge">select count(distinct m.age) from Member m</code></p><li><p>DISTINCT를 COUNT에서 사용할 때 임베디드 타입은 지원하지 않는다.</p></ul><h4 id="group-by-having">GROUP BY, HAVING</h4><p>다음 코드는 그룹별 통계 데이터 중에서 평균나이가 10살 이상인 그룹을 조회한다.</p><div class="language-sql highlighter-rouge"><div class="code-header"> <span text-data=" Sql "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">select</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">age</span><span class="p">),</span> <span class="k">sum</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">age</span><span class="p">),</span> <span class="k">avg</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">age</span><span class="p">),</span> <span class="k">max</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">age</span><span class="p">),</span> <span class="k">min</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">age</span><span class="p">)</span>
<span class="k">from</span> <span class="n">Member</span> <span class="n">m</span> <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">m</span><span class="p">.</span><span class="n">team</span> <span class="n">t</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span>
<span class="k">HAVING</span> <span class="k">avg</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">age</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">10</span>
</pre></table></code></div></div><h3 id="926-jpql-조인">9.2.6 JPQL 조인</h3><p>JPQL도 조인을 지원하는데 SQL 조인과 기능은 같고 문법만 약간 다르다.</p><h4 id="내부-조인">내부 조인</h4><p>INNER JOIN을 사용한다. INNER는 생략 가능하다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nc">String</span> <span class="n">teamName</span> <span class="o">=</span> <span class="s">"팀A"</span><span class="o">;</span>
<span class="nc">String</span> <span class="n">query</span> <span class="o">=</span> <span class="s">"SELECT m FROM Member m INNER JOIN m.team t "</span>
  <span class="o">+</span> <span class="s">"WHERE t.name = :teamName"</span><span class="o">;</span>

<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="n">members</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="nc">Member</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"teamName"</span><span class="o">,</span> <span class="n">teamName</span><span class="o">)</span>
  <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
</pre></table></code></div></div><p>JPQL 조인의 가장 큰 특징은 <strong>연관 필드</strong>를 사용한다는 것이다.</p><ul><li><code class="language-plaintext highlighter-rouge">FROM Member m</code>: 회원을 선택하고 m이라는 별칭을 주었다.<li><code class="language-plaintext highlighter-rouge">Member m JOIN m.team t</code>: 회원이 가지고 있는 연관 필드로 팀과 조인한다. 조인한 팀에는 t라는 별칭을 주었다.</ul><p>만약 조인한 두 개의 엔티티를 조회하려면 다음과 같이 JPQL을 작성하면 된다.</p><div class="language-sql highlighter-rouge"><div class="code-header"> <span text-data=" Sql "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">select</span> <span class="n">m</span><span class="p">,</span> <span class="n">t</span>
<span class="k">from</span> <span class="n">Member</span> <span class="n">m</span> <span class="k">join</span> <span class="n">m</span><span class="p">.</span><span class="n">team</span> <span class="n">t</span>
</pre></table></code></div></div><h4 id="외부-조인">외부 조인</h4><div class="language-sql highlighter-rouge"><div class="code-header"> <span text-data=" Sql "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">select</span> <span class="n">m</span>
<span class="k">from</span> <span class="n">Member</span> <span class="n">m</span> <span class="k">left</span> <span class="p">[</span><span class="k">outer</span><span class="p">]</span> <span class="k">join</span> <span class="n">m</span><span class="p">.</span><span class="n">team</span> <span class="n">t</span> 
</pre></table></code></div></div><p>outer는 생략 가능해서 보통 left 조인으로 사용한다.</p><h4 id="컬렉션-조인">컬렉션 조인</h4><p>일대다, 다대다 관계처럼 컬렉션을 사용하는 곳에 조인하는 것을 컬렉션 조인이라 한다.</p><p>팀 → 회원은 일대다 조인이면서 컬렉션 값 연관 필드<sup>t.members</sup>를 사용한다.</p><p><code class="language-plaintext highlighter-rouge">select t, m from Team t left join t.members m</code></p><p>팀과 팀이 보유한 회원 목록을 컬렉션 값 연관 필드로 외부 조인했다.</p><h4 id="세타-조인">세타 조인</h4><blockquote><p>카테시안곱에서 선택연산이 비교 연산자가 사용되는 것. 특별히 = 연산이 사용되는 경우를 동등<sup>equi</sup> 조인이라 한다.</p></blockquote><p>WHERE 절을 사용해서 세타 조인을 할 수 있다. 세타조인은 내부 조인만 지원한다. 세타 조인을 사용하면 전혀 관계 없는 엔티티도 조인할 수 있다.</p><div class="language-sql highlighter-rouge"><div class="code-header"> <span text-data=" Sql "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="o">//</span> <span class="n">JPQL</span>
<span class="k">select</span> <span class="k">count</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">from</span> <span class="n">Member</span> <span class="n">m</span><span class="p">,</span> <span class="n">Team</span> <span class="n">t</span>
<span class="k">where</span> <span class="n">m</span><span class="p">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span>

<span class="o">//</span> <span class="k">SQL</span>
<span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">M</span><span class="p">.</span><span class="n">ID</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">MEMBER</span> <span class="n">M</span> <span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">TEAM</span> <span class="n">T</span>
<span class="k">WHERE</span> <span class="n">M</span><span class="p">.</span><span class="n">USERNAME</span><span class="o">=</span><span class="n">T</span><span class="p">.</span><span class="n">NAME</span>
</pre></table></code></div></div><h4 id="join-on-절jpa-21">JOIN ON 절<sup>JPA 2.1</sup></h4><p>ON 절을 사용하면 조인 대상을 필터링하고 조인할 수 있다. 참고로 내부 조인의 결과는 ON 절 = WHERE 절이므로 보통 외부 조인에서만 사용된다.</p><div class="language-sql highlighter-rouge"><div class="code-header"> <span text-data=" Sql "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="o">//</span> <span class="n">JPQL</span>
<span class="k">select</span> <span class="n">m</span><span class="p">,</span> <span class="n">t</span> <span class="k">from</span> <span class="n">Member</span> <span class="n">m</span>
<span class="k">left</span> <span class="k">join</span> <span class="n">m</span><span class="p">.</span><span class="n">team</span> <span class="n">t</span> <span class="k">on</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">'A'</span>
  
<span class="o">//</span> <span class="k">SQL</span>
<span class="k">select</span> <span class="n">m</span><span class="p">.</span><span class="o">*</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="o">*</span> <span class="k">from</span> <span class="n">Member</span> <span class="n">m</span>
<span class="k">left</span> <span class="k">join</span> <span class="n">Team</span> <span class="n">t</span> <span class="k">on</span> <span class="n">m</span><span class="p">.</span><span class="n">team_id</span> <span class="k">and</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="o">=</span><span class="s1">'A'</span>
</pre></table></code></div></div><h3 id="927-페치-조인">9.2.7 페치 조인</h3><p>페치<sup>fetch</sup> 조인은 SQL에서 이야기하는 조인의 종류가 아니라 JPQL에서 성능 최적화를 위해 제공하는 기능으로 연관된 엔티티나 컬렉션을 한 번에 같이 조회하는 기능이다. join fetch 명령어로 사용할 수 있다.</p><h4 id="엔티티-페치-조인">엔티티 페치 조인</h4><p>회원 엔티티를 조회하면서 연관된 팀 엔티티도 함께 조회하는 JPQL을 보자.</p><div class="language-sql highlighter-rouge"><div class="code-header"> <span text-data=" Sql "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">select</span> <span class="n">m</span>
<span class="k">from</span> <span class="n">Member</span> <span class="n">m</span> <span class="k">join</span> <span class="k">fetch</span> <span class="n">m</span><span class="p">.</span><span class="n">team</span>
</pre></table></code></div></div><p>여기선 회원과 팀을 함께 조회한다. 페치 조인은 별칭을 사용할 수 없지만 하이버네이트 구현체에선 사용할 수 있도록 구현되었다.</p><blockquote><p><em>페치 조인 사용</em></p></blockquote><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nc">String</span> <span class="n">jpql</span> <span class="o">=</span> <span class="s">"select m from Member m join fetch m.team"</span><span class="o">;</span>

<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="n">members</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">jpql</span><span class="o">,</span> <span class="nc">Member</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
</pre></table></code></div></div><blockquote><p><em>실행된 SQL</em></p></blockquote><div class="language-sql highlighter-rouge"><div class="code-header"> <span text-data=" Sql "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">select</span> <span class="n">m</span><span class="p">.</span><span class="o">*</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="o">*</span>
<span class="k">from</span> <span class="n">member</span> <span class="n">m</span>
<span class="k">inner</span> <span class="k">join</span> <span class="n">team</span> <span class="n">t</span> <span class="k">on</span> <span class="n">m</span><span class="p">.</span><span class="n">team_id</span><span class="o">=</span><span class="n">t</span><span class="p">.</span><span class="n">id</span>
</pre></table></code></div></div><p>엔티티페치 조인에서 회원 엔티티만 선택했는데 SQL을 보면 회원과 연관된 팀도 함께 조회된 것을 확인할 수 있다.</p><p>회원과 팀을 지연 로딩으로 설정해도 회원을 조회할 때 페치 조인으로 함께 조회했으므로 연관된 팀 엔티티는 프록시가 아닌 실제 엔티티다. 따라서 연관된 팀을 사용해도 지연 로딩이 발생하지 않는다. 또한 실제 엔티티이므로 회원 엔티티가 준영속 상태가 되어도 연관된 팀을 조회할 수 있다.</p><h4 id="컬렉션-페치-조인">컬렉션 페치 조인</h4><blockquote><p><em>JPQL</em></p></blockquote><div class="language-sql highlighter-rouge"><div class="code-header"> <span text-data=" Sql "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">select</span> <span class="n">t</span>
<span class="k">from</span> <span class="n">Team</span> <span class="n">t</span> <span class="k">join</span> <span class="k">fetch</span> <span class="n">t</span><span class="p">.</span><span class="n">members</span>
<span class="k">where</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">'팀A'</span>
</pre></table></code></div></div><blockquote><p><em>실행된 SQL</em></p></blockquote><div class="language-sql highlighter-rouge"><div class="code-header"> <span text-data=" Sql "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">SELECT</span> <span class="n">T</span><span class="p">.</span><span class="o">*</span><span class="p">,</span> <span class="n">M</span><span class="p">.</span><span class="o">*</span>
<span class="k">FROM</span> <span class="n">TEAM</span> <span class="n">T</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">MEMBER</span> <span class="n">M</span> <span class="k">ON</span> <span class="n">T</span><span class="p">.</span><span class="n">ID</span><span class="o">=</span><span class="n">M</span><span class="p">.</span><span class="n">TEAM_ID</span>
<span class="k">WHERE</span> <span class="n">T</span><span class="p">.</span><span class="n">NAME</span><span class="o">=</span><span class="s1">'팀A'</span>
</pre></table></code></div></div><p>마찬가지로 팀만 선택했는데 팀과 연관된 회원도 함께 조회한 것을 볼 수 있다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">teamname</span> <span class="o">=</span> <span class="n">팀A</span><span class="o">,</span> <span class="n">team</span> <span class="o">=</span> <span class="nc">Team</span><span class="err">@</span><span class="mh">0x100</span>
<span class="o">-&gt;</span><span class="n">username</span> <span class="o">=</span> <span class="n">회원1</span><span class="o">,</span> <span class="n">member</span> <span class="o">=</span> <span class="nc">Member</span><span class="err">@</span><span class="mh">0x200</span>
<span class="o">-&gt;</span><span class="n">username</span> <span class="o">=</span> <span class="n">회원2</span><span class="o">,</span> <span class="n">member</span> <span class="o">=</span> <span class="nc">Member</span><span class="err">@</span><span class="mh">0x300</span>
<span class="n">teamname</span> <span class="o">=</span> <span class="n">팀A</span><span class="o">,</span> <span class="n">team</span> <span class="o">=</span> <span class="nc">Team</span><span class="err">@</span><span class="mh">0x100</span>
<span class="o">-&gt;</span><span class="n">username</span> <span class="o">=</span> <span class="n">회원1</span><span class="o">,</span> <span class="n">member</span> <span class="o">=</span> <span class="nc">Member</span><span class="err">@</span><span class="mh">0x200</span>
<span class="o">-&gt;</span><span class="n">username</span> <span class="o">=</span> <span class="n">회원2</span><span class="o">,</span> <span class="n">member</span> <span class="o">=</span> <span class="nc">Member</span><span class="err">@</span><span class="mh">0x300</span>
</pre></table></code></div></div><p>TEAM 테이블에서 ‘팀A’는 하나지만 MEMBER 테이블과 조인하면서 결과가 증가<sup>ex) 팀A에 속한 회원이 2명</sup>해서 같은 ‘팀A’가 2건 조회되었다. 따라서 중복 제거가 필요하다.</p><h4 id="페치-조인과-distinct">페치 조인과 DISTINCT</h4><p>JPQL의 DISTINCT 명령어는 SQL에 DISTINCT를 추가하고 애플리케이션에서 한 번 더 중복을 제거한다.</p><div class="language-sql highlighter-rouge"><div class="code-header"> <span text-data=" Sql "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">select</span> <span class="k">distinct</span> <span class="n">t</span>
<span class="k">from</span> <span class="n">Team</span> <span class="n">t</span> <span class="k">join</span> <span class="k">fetch</span> <span class="n">t</span><span class="p">.</span><span class="n">members</span>
<span class="k">where</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">'팀A'</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">select distinct t</code>는 팀 엔티티의 중복을 제거하라는 것이다. 따라서 이제 ‘팀A’는 하나만 조회된다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">teamname</span> <span class="o">=</span> <span class="n">팀A</span><span class="o">,</span> <span class="n">team</span> <span class="o">=</span> <span class="nc">Team</span><span class="err">@</span><span class="mh">0x100</span>
<span class="o">-&gt;</span><span class="n">username</span> <span class="o">=</span> <span class="n">회원1</span><span class="o">,</span> <span class="n">member</span> <span class="o">=</span> <span class="nc">Member</span><span class="err">@</span><span class="mh">0x200</span>
<span class="o">-&gt;</span><span class="n">username</span> <span class="o">=</span> <span class="n">회원2</span><span class="o">,</span> <span class="n">member</span> <span class="o">=</span> <span class="nc">Member</span><span class="err">@</span><span class="mh">0x300</span>
</pre></table></code></div></div><h4 id="페치-조인과-일반-조인의-차이">페치 조인과 일반 조인의 차이</h4><p>JPQL은 결과를 반환할 때 연관관계까지 고려하지 않는다. 단지 SELECT 절에 지정한 엔티티만 조회할 뿐이다. 만약 회원 컬렉션을 지연 로딩으로 설정하면 프록시나 아직 초기화하지 않은 컬렉션 래퍼를 반환한다. 즉시 로딩으로 설정하면 회원 컬렉션을 즉시 로딩하기 위해 쿼리를 한 번 더 실행한다.</p><p>반면에 페치 조인을 사용하면 연관된 엔티티도 같이 조회한다.</p><h4 id="페치-조인의-특징과-한계">페치 조인의 특징과 한계</h4><p>페치 조인을 사용하면 SQL 한 번으로 연관된 엔티티들을 조회할 수 있어서 성능을 최적화할 수 있다.</p><p>페치 조인은 글로벌 로딩 전략보다 우선한다. 예를 들어 지연 로딩으로 설정해도 JPQL에서 페치 조인을 사용하면 페치 조인을 적용해서 함께 조회한다.</p><p><strong>최적화를 위해 글로벌 로딩 전략을 즉시 로딩으로 설정하면 애플리케이션 전체에서 항상 즉시 로딩이 일어난다.</strong> <strong>일부는 빠를 수 있어도 전체로 보면 자주 사용하지 않는 엔티티를 자주 로딩하므로 오히려 성능에 악영향을 미칠 수 있다.</strong> <strong>따라서 되도록 지연 로딩을 사용하고 최적화가 필요하면 페치 조인을 적용하는 것이 효과적이다.</strong></p><p>페치 조인은 다음과 같은 한계가 있다.</p><ul><li><p><strong>페치 조인 대상에는 별칭을 줄 수 없다.</strong></p><li><strong>둘 이상의 컬렉션을 페치할 수 없다.</strong><li><strong>컬렉션을 페치 조인하면 페이징 API를 사용할 수 없다.</strong></ul><h3 id="928-경로-표현식">9.2.8 경로 표현식</h3><p>경로 표현식이란 쉽게 표현해서 <code class="language-plaintext highlighter-rouge">.</code>을 찍어 객체 그래프를 탐색하는 것이다.</p><h4 id="용어-정리">용어 정리</h4><ul><li><strong>상태 필드</strong><sup>state field</sup>: 단순히 값을 저장하기 위한 필드<li><strong>연관 필드</strong><sup>association field</sup>: 연관관계를 위한 필드, 임베디드 타입 포함<ul><li><strong>단일 값 연관 필드</strong>: @ManyToOne, @OneToOne, 대상이 엔티티<li><strong>컬렉션 값 연관 필드</strong>: @OneToMany, @ManyToMany, 대상이 컬렉션</ul></ul><blockquote><p><em>상태 필드 연관 필드 예제</em></p></blockquote><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Member</span> <span class="o">{</span>
  
  <span class="nd">@Id</span> <span class="nd">@GeneratedValue</span>
  <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
  
  <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"name"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span> <span class="c1">// 상태 필드</span>
  <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">age</span><span class="o">;</span>     <span class="c1">// 상태 필드</span>
  
  <span class="nd">@ManyToOne</span><span class="o">(..)</span>
  <span class="kd">private</span> <span class="nc">Team</span> <span class="n">team</span><span class="o">;</span>       <span class="c1">// 단일 값 연관 필드</span>
  
  <span class="nd">@OneToMany</span><span class="o">(..)</span>
  <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;</span> <span class="n">orders</span><span class="o">;</span> <span class="c1">// 컬렉션 값 연관 필드</span>
  
<span class="o">}</span>
</pre></table></code></div></div><h4 id="경로-표현식과-특징">경로 표현식과 특징</h4><ul><li><p><strong>상태 필드 경로</strong>: 경로 탐색의 끝이다. 더는 탐색할 수 없다.</p><li><p><strong>단일 값 연관 경로</strong>: 묵시적으로 내부 조인이 일어난다. 계속 탐색할 수 있다.</p><li><p><strong>컬렉션 값 연관 경로</strong>: 묵시적으로 내부 조인이 일어난다. 더는 탐색할 수 없다.</p><p>단 FROM 절에서 조인을 통해 별칭을 얻으면 탐색할 수 있다.</p><li><p><strong>명시적 조인</strong>: JOIN을 직접 적어주는 것</p><li><p><strong>묵시적 조인</strong>: 경로 표현식에 의해 조인이 일어나는 것, 내부 조인만 할 수 있다.</p><p><code class="language-plaintext highlighter-rouge">select m.team from Member m</code></p><li><p><strong>컬렉션 값 연관 경로 탐색</strong></p><div class="language-sql highlighter-rouge"><div class="code-header"> <span text-data=" Sql "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">select</span> <span class="n">t</span><span class="p">.</span><span class="n">members</span> <span class="k">from</span> <span class="n">Team</span> <span class="n">t</span> <span class="o">//</span> <span class="err">성공</span>
<span class="k">select</span> <span class="n">t</span><span class="p">.</span><span class="n">members</span><span class="p">.</span><span class="n">username</span> <span class="k">from</span> <span class="n">Team</span> <span class="n">t</span> <span class="o">//</span> <span class="err">실패</span>
  
<span class="k">select</span> <span class="n">m</span><span class="p">.</span><span class="n">username</span> <span class="k">from</span> <span class="n">Team</span> <span class="n">t</span> <span class="k">join</span> <span class="n">t</span><span class="p">.</span><span class="n">members</span> <span class="n">m</span> <span class="o">//</span> <span class="err">이처럼</span> <span class="err">해야함</span>
<span class="k">select</span> <span class="n">t</span><span class="p">.</span><span class="n">members</span><span class="p">.</span><span class="k">size</span> <span class="k">from</span> <span class="n">Team</span> <span class="n">t</span> <span class="o">//</span> <span class="k">size</span> <span class="err">사용</span> <span class="err">가능</span> <span class="k">COUNT</span><span class="err">로</span> <span class="err">적절히</span> <span class="err">변환</span> <span class="err">됨</span>
</pre></table></code></div></div><li><h4 id="묵시적-조인-시-주의사항"><strong>묵시적 조인 시 주의사항</strong></h4><ul><li><strong>항상 내부 조인이다.</strong><li>컬렉션은 경로 탐색의 끝이다. 탐색하려면 명시적으로 조인을 해서 별칭을 얻어야 한다.</ul></ul><p>​ 조인이 성능상 차지하는 부분은 아주 크다. 따라서 성능이 중요하면 분석하기 쉽도록 명시적 조인을 사용하자.</p><h3 id="929-서브-쿼리">9.2.9 서브 쿼리</h3><p>JPQL에선 서브 쿼리를 WHERE, HAVING 절에서만 사용할 수 있고 하이버네이트는 추가적으로 SELECT 절의 서브 쿼리도 허용한다.</p><blockquote><p>나이가 평균보다 많은 회원 예제</p></blockquote><div class="language-sql highlighter-rouge"><div class="code-header"> <span text-data=" Sql "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">select</span> <span class="n">m</span> <span class="k">from</span> <span class="n">Member</span> <span class="n">m</span>
<span class="k">where</span> <span class="n">m</span><span class="p">.</span><span class="n">age</span> <span class="o">&gt;</span> <span class="p">(</span><span class="k">select</span> <span class="k">avg</span><span class="p">(</span><span class="n">m2</span><span class="p">.</span><span class="n">age</span><span class="p">)</span> <span class="k">from</span> <span class="n">Member</span> <span class="n">m2</span><span class="p">)</span>
</pre></table></code></div></div><h4 id="서브-쿼리-함수">서브 쿼리 함수</h4><ul><li>[NOT] EXISTS : 서브 쿼리에 결과가 존재하면 참<li><div class="table-wrapper"><table><tbody><tr><td>{ ALL<td>ANY<td>SOME } :</table></div><ul><li>ALL: 조건을 모두 만족하면 참<li>ANY 혹은 SOME: 조건을 하나라도 만족하면 참</ul><li>[NOT] IN : 서브 쿼리의 결과 중 하나라도 같은 것이 있으면 참</ul><h3 id="9210-조건식">9.2.10 조건식</h3><p>####</p><h4 id="타입-표현">타입 표현</h4><div class="table-wrapper"><table><thead><tr><th>종류<th>설명<th>예제<tbody><tr><td>문자<td> <td>‘HELLO’<br />‘She’’s’<tr><td>숫자<td> <td>10L<br />10D<br />10F<tr><td>날짜<td>DATE {d ‘yyyy-mm-dd’}<br />TIME {t ‘hh-mm-ss’}<br />DATETIME {ts ‘yyyy-mm-dd hh:mm:ss.f’}<td>{d ‘2012-03-24’}<br />{ts ‘2012-03-24 10-11-11.123’}<tr><td>Boolean<td>TRUE, FALSE<td> <tr><td>Enum<td>패키지명을 포함한 전체 이름을 사용해야 한다.<td>jpabook.MemberType.Admin<tr><td>엔티티 타입<td>엔티티의 타입을 표현한다. 주로 상속과 관련해서 사용한다.<td>TYPE(m) = Member</table></div><h4 id="between">Between</h4><ul><li>X [NOT] BETWEEN A AND B: X는 A ~ B 사이의 값이면 참 (A, B값 포함)</ul><h4 id="컬렉션-식">컬렉션 식</h4><ul><li><p><strong>빈 컬렉션 비교 식</strong></p><ul><li>{컬렉션 값 연관 경로} IS [NOT] EMPTY</ul><li><p><strong>컬렉션의 멤버 식</strong>: 엔티티나 값이 컬렉션에 포함되어 있으면 참</p><ul><li><p>{엔티티나 값} [NOT] MEMBER [OF] {컬렉션 값 연관 경로}</p><p><code class="language-plaintext highlighter-rouge">select t from Team t where :memberParam member of t.members</code></p></ul></ul><h4 id="case-식">CASE 식</h4><ul><li>기본 CASE<li>심플 CASE<li>COALESCE<li>NULLIF</ul><h3 id="9211-다형성-쿼리">9.2.11 다형성 쿼리</h3><h3 id="9212-사용자-정의-함수-호출jpa-21">9.2.12 사용자 정의 함수 호출<sup>JPA 2.1</sup></h3><p>.</p><p>.</p><p>.</p><h3 id="9215-named-쿼리-정적-쿼리">9.2.15 Named 쿼리: 정적 쿼리</h3><ul><li><strong>동적 쿼리</strong>: em.createQuery(“select ..”) 처럼 JPQL을 문자로 완성해서 직접 넘기는 것을 동적 쿼리라 한다. 런타임에 특정 조건에 따라 JPQL을 동적으로 구성할 수 있다.<li><strong>정적 쿼리</strong>: 미리 정의한 쿼리에 이름을 부여해서 필요할 떄 사용할 수 있는데 이 것을 Named 쿼리라 한다. Named 쿼리는 한 번 정의하면 변경할 수 없는 정적인 쿼리다.</ul><p>Named 쿼리는 애플리케이션 로딩 시점에 JPQL 문법을 체크하고 미리 파싱해둔다. 따라서 오류를 빨리 확인할 수 있고, 사용하는 시점에는 파싱된 결과를 재사용하므로 성능상 이점도 있다.</p><p>Named 쿼리는 @NamedQuery 애노테이션을 사용해서 자바 코드에 작성하거나 XML 문서에 작성할 수 있다.</p><h4 id="애노테이션에-정의">애노테이션에 정의</h4><blockquote><p><em>정의</em></p></blockquote><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nd">@Entity</span>
<span class="nd">@NamedQuery</span><span class="o">(</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s">"Member.findByUsername"</span><span class="o">,</span>
  <span class="n">query</span> <span class="o">=</span> <span class="s">"select m from Member m where m.username = :username"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Member</span> <span class="o">{</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></table></code></div></div><blockquote><p><em>사용</em></p></blockquote><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="n">resultList</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createNamedQuery</span><span class="o">(</span><span class="s">"Member.findByUsername"</span><span class="o">,</span> <span class="nc">Member</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"username"</span><span class="o">,</span> <span class="s">"회원1"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>
</pre></table></code></div></div><p>하나의 엔티티에 2개 이상의 Named 쿼리를 정의하려면 @NamedQueries를 사용하면 된다.</p><h4 id="named-쿼리를-xml에-정의">Named 쿼리를 XML에 정의</h4><p>JPA에서 애노테이션으로 작성할 수 있는 것은 XML로도 작성할 수 있다.</p><p>만약 XML과 애노테이션에서 같은 설정이 있으면 <strong>XML이 우선권을 가진다.</strong></p><h2 id="94-querydsl">9.4 QueryDSL</h2><p>Criteria는 문자가 아닌 코드로 JPQL을 작성하므로 문법 오류를 컴파일 단계에서 잡을 수 있고 자동완성 기능의 도움을 받을 수 있는 등 여러 가지 장점이 있지만 너무 복잡하고 어렵다. QueryDSL도 Criteria처럼 JPQL 빌더 역할을 하므로 대체할 수 있다.</p><p>메이븐 설정을 마치고 콘솔에서 <code class="language-plaintext highlighter-rouge">mvn compile</code>을 입력하면 <code class="language-plaintext highlighter-rouge">outputDirectory</code>에 지정한 target/generated-sources 위치에 Q로 시작하는 쿼리 타입들이 생성된다.</p><h3 id="시작">시작</h3><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">queryDSL</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">emf</span><span class="o">.</span><span class="na">crateEntityManager</span><span class="o">();</span>
  
  <span class="nc">JPAQuery</span> <span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JPAQuery</span><span class="o">(</span><span class="n">em</span><span class="o">);</span>
  <span class="nc">QMember</span> <span class="n">qMember</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">QMember</span><span class="o">(</span><span class="s">"m"</span><span class="o">);</span> <span class="c1">// 생성되는 JPQL의 별칭 m</span>
  
  <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="n">members</span> <span class="o">=</span>
    <span class="n">query</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">qMember</span><span class="o">)</span>
    <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">qMember</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="s">"회원1"</span><span class="o">))</span>
    <span class="o">.</span><span class="na">orderBy</span><span class="o">(</span><span class="n">qMember</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">desc</span><span class="o">())</span>
    <span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">qMember</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>QueryDSL을 사용하려면 우선 JPAQuery 객체를 생성해야 하는데 이때 엔티티 매니저를 생성자에 넘겨준다.<li>다음으로 사용할 쿼리 타입을 생성하는데 생성자에는 별칭을 주면 된다. 이 별칭을 JPQL에서 별칭으로 사용한다.<li>그 다음 코드들은 보기만해도 쉽게 이해할 수 있을 것이다.</ul><h4 id="기본-q-생성">기본 Q 생성</h4><p>쿼리 타입은 사용하기 편하도록 기본 인스턴스를 보관하고 있다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nd">@Generated</span><span class="o">(</span><span class="s">"com.querydsl.codegen.EntitySerializer"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">QAccount</span> <span class="kd">extends</span> <span class="nc">EntityPathBase</span><span class="o">&lt;</span><span class="nc">Account</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">QAccount</span> <span class="n">account</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">QAccount</span><span class="o">(</span><span class="s">"account"</span><span class="o">);</span>
    
    <span class="o">...</span>
</pre></table></code></div></div><p>하지만 같은 엔티티끼리 조인하거나 서브쿼리에 사용하면 같은 별칭이 되므로 이때는 별칭을 직접 지정해서 사용해야 한다.</p><h3 id="프로젝션과-결과-반환">프로젝션과 결과 반환</h3><p>select 절에 조회 대상을 지정하는 것을 프로젝션이라 했다.</p><h4 id="프로젝션-대상이-하나">프로젝션 대상이 하나</h4><div class="language-javascript highlighter-rouge"><div class="code-header"> <span text-data=" JavaScript "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nx">QItem</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">QItem</span><span class="p">.</span><span class="nx">item</span><span class="p">;</span>
<span class="nx">List</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">query</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">item</span><span class="p">).</span><span class="nx">list</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
</pre></table></code></div></div><p>프로젝션 대상이 하나면 해당 타입으로 반환한다.</p><h4 id="여러-컬럼-반환과-튜플">여러 컬럼 반환과 튜플</h4><p>프로젝션 대상으로 여러 필드를 선택하면 QueryDSL은 기본으로 Tuple이라는 Map과 비슷한 내부 타입을 사용한다. 조회 결과는 <code class="language-plaintext highlighter-rouge">tuple.get()</code> 메서드에 조회한 쿼리 타입을 지정하면 된다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nc">QItem</span> <span class="n">item</span> <span class="o">=</span> <span class="nc">QItem</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>

<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Tuple</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">item</span><span class="o">).</span><span class="na">list</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">item</span><span class="o">.</span><span class="na">price</span><span class="o">);</span>

<span class="k">for</span> <span class="o">(</span><span class="nc">Tuple</span> <span class="n">tuple</span> <span class="o">:</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"name = "</span> <span class="o">+</span> <span class="n">tuple</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">name</span><span class="o">));</span>
  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"price = "</span> <span class="o">+</span> <span class="n">tuple</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">price</span><span class="o">));</span>
<span class="o">}</span>
</pre></table></code></div></div><h4 id="빈-생성dto">빈 생성<sup>DTO</sup></h4><p>쿼리 결과를 엔티티가 아닌 특정 객체로 받고 싶으면 빈 생성 기능을 사용한다. (더 자주 사용됨) QueryDSL은 객체를 생성하는 다양한 방법을 제공한다.</p><ul><li>프로퍼티 접근<li>필드 직접 접근<li>생성자 사용</ul><p>원하는 방법을 지정하기 위해 Projections를 사용하면 된다.</p><blockquote><p><em>예제 ItemDTO</em></p></blockquote><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nd">@Getter</span>
<span class="nd">@Setter</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ItemDTO</span> <span class="o">{</span>
  
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">price</span><span class="o">;</span>
  
<span class="o">}</span>
</pre></table></code></div></div><blockquote><p><em>프로퍼티 접근</em><sup>Setter</sup></p></blockquote><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nc">QItem</span> <span class="n">item</span> <span class="o">=</span> <span class="nc">QItem</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">ItemDTO</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">item</span><span class="o">).</span><span class="na">list</span><span class="o">(</span>
  <span class="nc">Projections</span><span class="o">.</span><span class="na">bean</span><span class="o">(</span><span class="nc">ItemDTO</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">item</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">as</span><span class="o">(</span><span class="s">"username"</span><span class="o">),</span> <span class="n">item</span><span class="o">.</span><span class="na">price</span><span class="o">));</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">bean()</code> 메서드는 Setter를 사용해서 값을 채운다. <code class="language-plaintext highlighter-rouge">as</code>를 사용해서 쿼리 결과인 name을 ItemDTO가 가지고 있는 프로퍼티인 username으로 변경했다. 이처럼 쿼리 결과와 매핑할 프로퍼티 이름이 다르면 <code class="language-plaintext highlighter-rouge">as</code>를 사용해서 별칭을 주면 된다.</p><blockquote><p>필드 직접 접근</p></blockquote><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nc">QItem</span> <span class="n">item</span> <span class="o">=</span> <span class="nc">QItem</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">ItemDTO</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">item</span><span class="o">).</span><span class="na">list</span><span class="o">(</span>
  <span class="nc">Projections</span><span class="o">.</span><span class="na">fields</span><span class="o">(</span><span class="nc">ItemDTO</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">item</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">as</span><span class="o">(</span><span class="s">"username"</span><span class="o">),</span> <span class="n">item</span><span class="o">.</span><span class="na">price</span><span class="o">));</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">fields()</code> 메서드는 필드에 직접 접근해서 값을 채워준다. 필드를 <code class="language-plaintext highlighter-rouge">private</code>로 설정해도 동작한다.</p><blockquote><p><em>생성자 사용</em></p></blockquote><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nc">QItem</span> <span class="n">item</span> <span class="o">=</span> <span class="nc">QItem</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">ItemDTO</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">item</span><span class="o">).</span><span class="na">list</span><span class="o">(</span>
  <span class="nc">Projections</span><span class="o">.</span><span class="na">constructor</span><span class="o">(</span><span class="nc">ItemDTO</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">item</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">item</span><span class="o">.</span><span class="na">price</span><span class="o">));</span>
</pre></table></code></div></div><p>지정한 프로젝션과 파라미터 순서가 같은 생성자가 필요하다.</p><h4 id="distinct">DISTINCT</h4><p><code class="language-plaintext highlighter-rouge">query.distinct().from(item)....</code></p><h3 id="수정-삭제-배치-쿼리">수정, 삭제 배치 쿼리</h3><p>QueryDSL도 수정, 삭제같은 배치 쿼리를 지원한다. JPQL 배치 쿼리와 같이 영속성 컨텍스트를 무시하고 데이터베이스에 직접 쿼리한다는 점을 유의하자.</p><blockquote><p><em>수정 배치 쿼리</em></p></blockquote><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nc">QItem</span> <span class="n">item</span> <span class="o">=</span> <span class="nc">QItem</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
<span class="nc">JPAUpdateClause</span> <span class="n">updateClause</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JPAUpdateClause</span><span class="o">(</span><span class="n">em</span><span class="o">,</span> <span class="n">item</span><span class="o">);</span>
<span class="kt">long</span> <span class="n">count</span> <span class="o">=</span> <span class="n">updateClause</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="s">"시골 개발자의 JPA 책"</span><span class="o">))</span>
  <span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">price</span><span class="o">,</span> <span class="n">item</span><span class="o">.</span><span class="na">price</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">100</span><span class="o">))</span>
  <span class="o">.</span><span class="na">execute</span><span class="o">();</span>
</pre></table></code></div></div><blockquote><p><em>삭제 배치 쿼리</em></p></blockquote><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nc">QItem</span> <span class="n">item</span> <span class="o">=</span> <span class="nc">QItem</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
<span class="nc">JPADeleteClause</span> <span class="n">deleteClause</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JPADeleteClause</span><span class="o">(</span><span class="n">em</span><span class="o">,</span> <span class="n">item</span><span class="o">);</span>
<span class="kt">long</span> <span class="n">count</span> <span class="o">=</span> <span class="n">deleteClause</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="s">"시골개발자의 JPA 책"</span><span class="o">))</span>
  <span class="o">.</span><span class="na">execute</span><span class="o">()</span>
</pre></table></code></div></div><h3 id="동적-쿼리">동적 쿼리</h3><p>BooleanBuilder를 사용하면 특정 조건에 따른 동적 쿼리를 편리하게 생성할 수 있다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="nc">SearchParam</span> <span class="n">param</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SearchParam</span><span class="o">();</span>
<span class="n">param</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"시골개발자"</span><span class="o">);</span>
<span class="n">param</span><span class="o">.</span><span class="na">setPrice</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>

<span class="nc">QItem</span> <span class="n">item</span> <span class="o">=</span> <span class="nc">QItem</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>

<span class="nc">BooleanBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BooleanBuilder</span><span class="o">();</span>
<span class="k">if</span> <span class="o">(</span><span class="nc">StringUtils</span><span class="o">.</span><span class="na">hasText</span><span class="o">(</span><span class="n">param</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
  <span class="n">builder</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">param</span><span class="o">.</span><span class="na">getName</span><span class="o">()));</span>
<span class="o">}</span>
<span class="k">if</span> <span class="o">(</span><span class="n">param</span><span class="o">.</span><span class="na">getPrice</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">builder</span><span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">price</span><span class="o">.</span><span class="na">gt</span><span class="o">(</span><span class="n">param</span><span class="o">.</span><span class="na">getPrice</span><span class="o">()));</span>
<span class="o">}</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Item</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">item</span><span class="o">)</span>
  <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">builder</span><span class="o">)</span>
  <span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">item</span><span class="o">);</span>
</pre></table></code></div></div><h3 id="메서드-위임">메서드 위임</h3><p>메서드 위임<sup>Delegate Methods</sup> 기능을 사용하면 쿼리 타입에 검색 조건을 직접 정의할 수 있다.</p><blockquote><p><em>검색 조건 정의</em></p></blockquote><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ItemExpression</span> <span class="o">{</span>
  
  <span class="nd">@QueryDelegate</span><span class="o">(</span><span class="nc">Item</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">BooleanExpression</span> <span class="nf">isExpensive</span><span class="o">(</span><span class="nc">QItem</span> <span class="n">item</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">price</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">item</span><span class="o">.</span><span class="na">price</span><span class="o">.</span><span class="na">gt</span><span class="o">(</span><span class="n">price</span><span class="o">);</span>
  <span class="o">}</span>
  
<span class="o">}</span>
</pre></table></code></div></div><p>메서드 위임 기능을 사용하기 위해 우선 static 메서드를 만들고 QueryDelegate 애노테이션으로 이 기능을 적용할 엔티티를 지정한다. 메서드의 첫 번째 파라미터에는 대상 엔티티의 쿼리 타입을 지정하고 나머지는 필요한 파라미터를 정의한다.</p><blockquote><p><em>쿼리 타입에 생성된 결과</em></p></blockquote><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">QItem</span> <span class="kd">extends</span> <span class="nc">EntityPathBase</span><span class="o">&lt;</span><span class="nc">Item</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">mysema</span><span class="o">.</span><span class="na">query</span><span class="o">.</span><span class="na">types</span><span class="o">.</span><span class="na">expr</span><span class="o">.</span><span class="na">BooleanExpression</span> <span class="nf">isExpensive</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">price</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">ItemExpression</span><span class="o">.</span><span class="na">isExpensive</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">price</span><span class="o">);</span>
  <span class="o">}</span>
  
<span class="o">}</span>
</pre></table></code></div></div><p>이제 메서드 위임 기능을 사용해보자.</p><p><code class="language-plaintext highlighter-rouge">query.from(item).where(item.isExpensive(30000)).list(item);</code></p><p>필요하다면 String, Date 같은 자바 기본 내장 타입에도 메서드 위임 기능을 사용할 수 있다.</p><h2 id="95-네이티브-sql">9.5 네이티브 SQL</h2><p>JPQL은 표준 SQL이 지원하는 대부분의 문법과 SQL 함수들을 지원하지만 특정 데이터베이스 종속적 기능은 지원하지 않는다.</p><p>JPQL에서 특정 데이터베이스에 종속적인 기능을 지원하는 방법은 다음과 같다.</p><ul><li><strong>특정 데이터베이스만 사용하는 함수</strong><ul><li>JPQL에서 네이티브 SQL 함수를 호출할 수 있다 <sup>JPA 2.1</sup>.<li>하이버네이트는 데이터베이스 방언에 각 데이터베이스에 종속적인 함수들을 정의해두었다.</ul><li><strong>특정 데이터베이스만 지원하는 SQL 쿼리 힌트</strong><ul><li>하이버네이트를 포함한 몇몇 JPA 구현체들이 지원한다.</ul><li><strong>인라인 뷰, UNION, INTERSECT</strong><ul><li>하이버네이트는 지원하지 않지만 일부 JPA 구현체들이 지원한다.</ul><li><strong>스토어드 프로시저</strong><ul><li>JPQL에서 스토어드 프로시저를 호출할 수 있다 <sup>JPA 2.1</sup></ul></ul><p>JDBC API와의 차이점이라면 <strong>네이티브 SQL은 JPA가 지원하는 영속성 컨텍스트의 기능을 그대로 사용</strong>할 수 있다.</p><p>네이티브 쿼리 API는 다음 3가지가 있다.</p><ul><li><p><strong>결과 타입 정의</strong></p><p><code class="language-plaintext highlighter-rouge">public Query createNativeQuery(String sqlString, Class resultClass);</code></p><li><p><strong>결과 타입을 정의할 수 없을 때</strong></p><p><code class="language-plaintext highlighter-rouge">public Query createNativeQuery(String sqlString);</code></p><li><p><strong>결과 매핑 사용</strong></p><p><code class="language-plaintext highlighter-rouge">public Query createNativeQuery(String sqlString, String resultSetMapping);</code></p></ul><p>네이티브 SQL도 JPQL을 사용할 때와 마찬가지로 Named 쿼리를 사용할 때 Query.TypeQuery를 반환한다. 따라서 JPQL API를 그대로 사용할 수 있다.</p><h2 id="96-객체지향-쿼리-심화">9.6 객체지향 쿼리 심화</h2><h3 id="961-벌크-연산">9.6.1 벌크 연산</h3><p>수백개 이상의 엔티티를 하나씩 처리하기에는 시간이 너무 오래걸린다. 이럴 때 여러 건을 한 번에 수정하거나 삭제하는 연산이다.</p><blockquote><p><em>UPDATE 벌크 연산</em></p></blockquote><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nc">String</span> <span class="n">qlString</span> <span class="o">=</span>
  <span class="s">"update Product p "</span> <span class="o">+</span>
  <span class="s">"set p.price = p.price * 1.1 "</span> <span class="o">+</span>
  <span class="s">"where p.stickAmount &lt; : stockAmount"</span><span class="o">;</span>

<span class="kt">int</span> <span class="n">resultCount</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">qlString</span><span class="o">)</span>
  <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"stockAmount"</span><span class="o">,</span> <span class="mi">10</span><span class="o">)</span>
  <span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>
</pre></table></code></div></div><blockquote><p><em>DELETE 벌크 연산</em></p></blockquote><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nc">String</span> <span class="n">qlString</span> <span class="o">=</span>
  <span class="s">"delete from Product p"</span> <span class="o">+</span>
  <span class="s">"where p.price &lt; :price"</span><span class="o">;</span>

<span class="kt">int</span> <span class="n">resultCount</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">qlString</span><span class="o">)</span>
  <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"price"</span><span class="o">,</span> <span class="mi">100</span><span class="o">)</span>
  <span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>
</pre></table></code></div></div><p>JPA 표준은 아니지만 하이버네이트는 INSERT 벌크 연산도 지원한다. 다음 코드는 100원 미만의 모든 상품을 ProductTemp에 저장한다.</p><blockquote><p><em>INSERT 벌크 연산</em></p></blockquote><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="nc">String</span> <span class="n">qlString</span> <span class="o">=</span> 
  <span class="s">"insert into ProductTemp(id, name, price, stockAmount) "</span> <span class="o">+</span>
  <span class="s">"select p.id, p.name, p.price, p.stockAmount from Product p "</span> <span class="o">+</span>
  <span class="s">"where p.price &lt; :price"</span><span class="o">;</span>

<span class="kt">int</span> <span class="n">resultCount</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">qlString</span><span class="o">)</span>
  <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"price"</span><span class="o">,</span> <span class="mi">100</span><span class="o">)</span>
  <span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>
</pre></table></code></div></div><h4 id="벌크-연산의-주의점">벌크 연산의 주의점</h4><p>벌크 연산을 사용할 때는 벌크 연산이 영속성 컨텍스트를 무시하고 데이터베이스에 직접 쿼리한다는 점에 주의해야 한다.</p><ol><li>가격이 1000원인 상품A를 조회했다. 조회된 상품 A는 영속성 컨텍스트에서 관리된다.<li>벌크 연산으로 모든 상품의 가격을 10% 상승시켰다. 따라서 가격은 1100원이 되어야 한다.<li>벌크 연산을 수행한 후에 가격을 출력하면 1100원이 아니라 1000원이 출력된다.</ol><p>벌크 연산은 영속성 컨텍스트를 통하지 않고 데이터베이스에 직접 쿼리하므로 영속성 컨텍스트에 있는 상품 A와 데이터베이스에 있는 상품A의 가격이 다를 수 있다. 이런 문제를 해결하는 방법을 살펴보자.</p><ul><li><p><strong>em.refresh() 사용</strong></p><p>벌크 연산을 수행한 직후에 정확한 상품 A 엔티티를 사용해야 한다면 <code class="language-plaintext highlighter-rouge">em.refresh(productA)</code>로 다시 조회하면 된다.</p><li><p><strong>벌크 연산 먼저 실행</strong></p><p>벌크 연산을 먼저 실행하고 나서 상품 A를 조회하면 이미 변경된 상품 A를 조회하게 된다.</p><li><p><strong>벌크 연산 수행 후 영속성 컨텍스트 초기화</strong></p><p>영속성 컨텍스트를 초기화하면 이후 엔티티를 조회할 때 벌크 연산이 적용된 데이터베이스에서 엔티티를 조회한다.</p></ul><p>가능하면 벌크 연산을 가장 먼저 실행하는 것이 좋고 상황에따라 초기화하는 것도 필요하다.</p><h4 id="find-vs-jpql">find() vs JPQL</h4><p>em.find() 메서드는 엔티티를 영속성 컨텍스트에서 먼저 찾고 없으면 데이터베이스에서 찾는다. 해당 엔티티가 영속성 컨텍스트에 있으면 메모리에서 바로 찾으므로<sup>1차 캐시</sup> 성능상 이점이 있다.</p><p>그에 비해 <strong>JPQL은 항상 데이터베이스에 SQL을 실행해서 결과를 조회한다.</strong></p><p>JPQL의 특징을 정리하자면</p><ul><li>JPQL은 항상 데이터베이스를 조회한다.<li>JPQL로 조회한 엔티티는 영속 상태다.<li>영속성 컨텍스트에 이미 존재하는 엔티티가 있으면 기존 엔티티를 반환한다.</ul><h3 id="963-jpql과-플러시-모드">9.6.3 JPQL과 플러시 모드</h3><p>플러시는 영속성 컨텍스트의 변경 내역을 데이터베이스에 동기화하는 것이다. JPA는 플러시가 일어날 때 영속성 컨텍스트에 등록, 수정, 삭제한 엔티티를 찾아서 INSERT, UPDATE, DELETE SQL을 만들어 데이터베이스에 반영한다.</p><p>플러시를 호출하려면 <code class="language-plaintext highlighter-rouge">em.flush()</code>를 직접 사용할수도 있지만 보통 플러시 모드에 따라 커밋하기 직전이나 쿼리 실행 직전에 자동으로 호출된다. 플러시 모드는 FlushModeType.AUTO가 기본값이므로 JPA는 트랙젝션 커밋 직전이나 쿼리 실행 직전에 자동으로 플러시를 호출한다.</p><blockquote><p><em>플러시 모드 설정</em></p></blockquote><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="n">em</span><span class="o">.</span><span class="na">setFlushMode</span><span class="o">(</span><span class="nc">FlushModeType</span><span class="o">.</span><span class="na">COMMIT</span><span class="o">);</span> <span class="c1">// 커밋 시에만 플러시</span>

<span class="c1">// 가격을 1000 -&gt; 2000으로 변경</span>
<span class="n">product</span><span class="o">.</span><span class="na">setPrice</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>

<span class="c1">// 1.em.flush() 직접 호출</span>

<span class="c1">// 가격이 2000인 상품 조회</span>
<span class="nc">Product</span> <span class="n">product2</span> <span class="o">=</span>
  <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"select p from Product p where p.price = 2000"</span><span class="o">,</span> <span class="nc">Product</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="o">.</span><span class="na">setFlushMode</span><span class="o">(</span><span class="nc">FlushModeType</span><span class="o">.</span><span class="na">AUTO</span><span class="o">)</span> <span class="c1">// 2. setFlushMode()</span>
  <span class="o">.</span><span class="na">getSingleResult</span><span class="o">();</span>
</pre></table></code></div></div><p>JPQL은 영속성 컨텍스트에 있는 데이터를 고려하지 않고 데이터베이스에서 데이터를 조회한다. 따라서 JPQL을 실행하기 전에 영속성 컨텍스트의 내용을 데이터베이스에 반영해야 한다.</p><p>플러시 모드의 기본값은 AUTO이므로 일반적인 상황에서는 위 내용을 고려하지 않아도 된다. 그렇다면 왜 COMMIT 모드를 사용하는 것일까?</p><h4 id="플러시-모드와-최적화">플러시 모드와 최적화</h4><p>COMMIT 모드는 트랜잭션을 커밋할 때만 플러시하고 쿼리를 실행할 때는 플러시하지 않는다. 따라서 데이터 무결성에 심각한 피해를 줄 수 있는데, 그럼에도 플러시가 너무 자주 일어나는 상황에 이 모드를 사용하면 플러시 횟수를 줄여서 성능을 최적화할 수 있다.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/jpa/'>JPA</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=자바 ORM 표준 JPA 프로그래밍(희망편09) - dev note&url=https://redbean88.github.io/posts/JPA-CH09/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=자바 ORM 표준 JPA 프로그래밍(희망편09) - dev note&u=https://redbean88.github.io/posts/JPA-CH09/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=자바 ORM 표준 JPA 프로그래밍(희망편09) - dev note&url=https://redbean88.github.io/posts/JPA-CH09/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/JPA-CH05/">자바 ORM 표준 JPA 프로그래밍(희망편05)</a><li><a href="/posts/JPA-CH06/">자바 ORM 표준 JPA 프로그래밍(희망편06)</a><li><a href="/posts/JPA-CH07/">자바 ORM 표준 JPA 프로그래밍(희망편07)</a><li><a href="/posts/JPA-CH09/">자바 ORM 표준 JPA 프로그래밍(희망편09)</a><li><a href="/posts/JPA-CH08/">자바 ORM 표준 JPA 프로그래밍(희망편08)</a></ul></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/JPA-CH01/"><div class="card-body"> <span class="timeago small" >Dec 23, 2021<i class="unloaded">2021-12-23T00:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>자바 ORM 표준 JPA 프로그래밍(희망편01)</h3><div class="text-muted small"><p> 프로젝트 생성 프로젝트를 진행하면서 하이버네이트의 사용법을 익혀보자 스프링 프로젝트 생성 pom.xml &lt;?xml version="1.0" encoding="UTF-8"?&gt; &lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w...</p></div></div></a></div><div class="card"> <a href="/posts/JPA-ETC00/"><div class="card-body"> <span class="timeago small" >Dec 23, 2021<i class="unloaded">2021-12-23T00:07:09+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>자바 ORM 표준 JPA 프로그래밍(번외1)</h3><div class="text-muted small"><p> 객체 세상 객체를 이해할려면 객체가 무엇인지 알아야 한다. 객체란 무엇일까? 컴퓨터 과학에서 객체 또는 오브젝트(object)는 클래스에서 정의한 것을 토대로 메모리(실제 저장공간)에 할당된 것으로 프로그램에서…. - 위키백과 위 정의를 보고 한번에 이해하는 특출난 분은 아래의 다른 설명으로 넘어가도 된다. 가장 쉽게 생각하자면 현실 세...</p></div></div></a></div><div class="card"> <a href="/posts/JPA-CH02/"><div class="card-body"> <span class="timeago small" >Jan 10, 2022<i class="unloaded">2022-01-10T21:54:47+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>자바 ORM 표준 JPA 프로그래밍(희망편02)</h3><div class="text-muted small"><p> 영속성 컨텍스트 영속성 컨텍스트란, java의 GC나 스프링의 빈 팩토리와 같이 DB 데이터관리를 이관하고 더불어 DB를 마치 메모리 DB를 이용하듯 객체화 시켜준다. 또한 이러한 정보는 객체와 마찬가지로 생명주기를 가지고 있다. 이런 생명주기는 4가지로 존재한다. 비영속(new/transient) : 영속성 컨텍스트와 전혀 관계 없는 상...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/JPA-CH07/" class="btn btn-outline-primary" prompt="Older"><p>자바 ORM 표준 JPA 프로그래밍(희망편07)</p></a> <a href="/posts/JPA-CH08/" class="btn btn-outline-primary" prompt="Newer"><p>자바 ORM 표준 JPA 프로그래밍(희망편08)</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://redbean88.github.io/posts/JPA-CH09/'; this.page.identifier = '/posts/JPA-CH09/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://redbean88-github-io.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (modeToggle !== null) { modeToggle.addEventListener('click', reloadDisqus); window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://redbean88.github.io">redbean88</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-LR635TNW07"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-LR635TNW07'); }); </script>
